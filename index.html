<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kam až dojdem o jarních prázdninách - mapa tříd</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid #e6e6e6; }
    h1 { margin: 0; font-size: 18px; }
    .sub { margin-top: 4px; color:#555; font-size: 14px; }
    #map { height: 62vh; width: 100%; }
    .wrap { padding: 12px 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f6ff; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>Kam až dojdem o jarních prázdninách</h1>
    <div class="sub">Vyberte cíl. Sbírejte kilometry. Cestujte světem.</div>
  </header>

  <div id="map"></div>

  <div class="wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>Třída</th>
          <th>Cíl</th>
          <th>Km</th>
          <th>Trasa (km)</th>
          <th>Hotovo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="muted" style="margin-top:10px;">
      Tip: Aktualizuj jen sloupec <b>km_aktualne</b> v Google Sheets a stránku obnov.
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1) DOPLŇ SEM URL NA CSV EXPORT TVÉHO SHEETU
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1xzz0uVPrmIYAKm3MUc5RuDRVh9Gzk0VX8762wxBGNqU/gviz/tq?tqx=out:csv&sheet=TRIDY";

    // 2) OSRM veřejný server (silniční routování)
    const OSRM_ROUTE = "https://router.project-osrm.org/route/v1/driving/";

    const map = L.map('map', { zoomControl: true }).setView([50.08, 14.43], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const layers = []; // pro případný cleanup

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(',').map(c => c.trim());
        const row = {};
        headers.forEach((h, i) => row[h] = cols[i]);
        return row;
      });
    }

    async function getRouteGeoJSON(startLng, startLat, endLng, endLat) {
      // geometries=geojson => Linestring, overview=full => plná trasa, alternatives=false => jedna trasa
      const url = `${OSRM_ROUTE}${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson&alternatives=false`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("OSRM error");
      const data = await res.json();
      const route = data.routes[0];
      return {
        distanceKm: route.distance / 1000,
        line: route.geometry // GeoJSON LineString
      };
    }

    function pointAlongLine(line, targetKm) {
      // line.coordinates: [ [lng,lat], ... ]
      // Najdeme bod po délce targetKm jednoduchým "po segmentech" (haversine aproximace).
      // Pro školní vizualizaci je to ok.
      const coords = line.coordinates;
      if (coords.length < 2) return coords[0];

      const R = 6371; // km
      const toRad = d => d * Math.PI / 180;

      function havKm(a, b) {
        const lat1 = toRad(a[1]), lon1 = toRad(a[0]);
        const lat2 = toRad(b[1]), lon2 = toRad(b[0]);
        const dLat = lat2 - lat1, dLon = lon2 - lon1;
        const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
        return 2 * R * Math.asin(Math.sqrt(s));
      }

      let acc = 0;
      for (let i = 0; i < coords.length - 1; i++) {
        const a = coords[i], b = coords[i+1];
        const seg = havKm(a, b);
        if (acc + seg >= targetKm) {
          const t = (targetKm - acc) / seg; // 0..1
          const lng = a[0] + (b[0] - a[0]) * t;
          const lat = a[1] + (b[1] - a[1]) * t;
          return [lng, lat];
        }
        acc += seg;
      }
      return coords[coords.length - 1];
    }

    function pct(x) {
      const p = Math.max(0, Math.min(1, x));
      return Math.round(p * 100) + "%";
    }

    function clearLayers() {
      layers.forEach(l => map.removeLayer(l));
      layers.length = 0;
    }

    async function render() {
      clearLayers();
      const csvText = await (await fetch(SHEET_URL)).text();
      const rows = parseCSV(csvText);

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      const bounds = [];

      for (const r of rows) {
        const trida = r.trida;
        const cil = r.cil;

        const startLat = Number(r.start_lat);
        const startLng = Number(r.start_lng);
        const endLat = Number(r.cil_lat);
        const endLng = Number(r.cil_lng);
        const kmAkt = Number(r.km_aktualne || 0);

        const route = await getRouteGeoJSON(startLng, startLat, endLng, endLat);
        const totalKm = route.distanceKm;

        const progress = totalKm > 0 ? (kmAkt / totalKm) : 0;
        const kmClamped = Math.max(0, Math.min(kmAkt, totalKm));
        const pos = pointAlongLine(route.line, kmClamped);

        // Polyline trasy
        const poly = L.geoJSON(route.line, { style: { weight: 4, opacity: 0.7 } }).addTo(map);
        layers.push(poly);

        // Marker aktuální pozice
        const marker = L.circleMarker([pos[1], pos[0]], { radius: 8, weight: 2 }).addTo(map)
          .bindPopup(`<b>${trida}</b><br>${cil}<br>${kmClamped.toFixed(0)} / ${totalKm.toFixed(0)} km (${pct(progress)})`);
        layers.push(marker);

        // Start a cíl (menší body)
        const startM = L.circleMarker([startLat, startLng], { radius: 4, weight: 1, opacity: 0.8 }).addTo(map);
        const endM = L.circleMarker([endLat, endLng], { radius: 4, weight: 1, opacity: 0.8 }).addTo(map);
        layers.push(startM, endM);

        bounds.push([startLat, startLng], [endLat, endLng]);

        // Tabulka
        const rowEl = document.createElement("tr");
        rowEl.innerHTML = `
          <td><span class="pill">${trida}</span></td>
          <td>${cil}</td>
          <td>${kmAkt.toFixed(0)}</td>
          <td>${totalKm.toFixed(0)}</td>
          <td>${pct(progress)}</td>
        `;
        rowEl.style.cursor = "pointer";
        rowEl.addEventListener("click", () => {
          map.setView([pos[1], pos[0]], 6);
          marker.openPopup();
        });
        tbody.appendChild(rowEl);
      }

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
    }

    render().catch(err => {
      alert("Chyba při načítání dat. Zkontroluj SHEET_URL a publikování sheetu.\n\n" + err.message);
      console.error(err);
    });
  </script>
</body>
</html>